<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> MEIZAN LOANS - Financial Information</title>
    <script src="https://cdn.tailwindcss.com"></script> 
 <script src="firebase-config.js"></script> 
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fb923c; /* Orange-300 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            margin: 0;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #16a34a; /* Green-600 */
        }
        input, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db; /* Gray-300 */
            border-radius: 0.5rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        input:focus, select:focus {
            border-color: #10b981; /* Emerald-500 */
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.5);
            outline: none;
        }
        /* Style for custom message box */
        #messageBox {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 500;
        }
        .success {
            background-color: #d1fae5; /* Green-100 */
            color: #059669; /* Green-600 */
            border: 1px solid #10b981; /* Green-500 */
        }
        .error {
            background-color: #fee2e2; /* Red-100 */
            color: #ef4444; /* Red-600 */
            border: 1px solid #f87171; /* Red-400 */
        }
        .info {
            background-color: #e0f2f1; /* Cyan-50 */
            color: #06b6d4; /* Cyan-600 */
            border: 1px solid #22d3ee; /* Cyan-400 */
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-3xl font-extrabold text-center text-green-600 mb-6">Step 2: Financial Information</h1>
    <p class="text-gray-600 text-center mb-6">Provide your current income details and bank account for loan disbursement.</p>

    <div id="messageBox" class="hidden" role="alert"></div>
    <div id="loadingMessage" class="hidden text-center text-gray-500 mb-4">Loading your data...</div>

    <form id="financialInfoForm">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
           
  <div class="input-group">
            <label for="employmentStatus">Employment Status</label>
            <select id="employmentStatus" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" required>
                <option value="">Select status</option>
                <option value="Employed">Employed (Full/Part Time)</option>
                <option value="Self-Employed">Self-Employed</option>
                <option value="Unemployed">Unemployed</option>
                <option value="Student">Student</option>
                <option value="Retired">Retired</option>
            </select>
        </div>
        <div class="input-group">
            <label for="occupation">Occupation/Business Type</label>
            <input type="text" id="occupation" placeholder="e.g. Software Developer, Groceries Store" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" required>
        </div>
        <div class="input-group">
            <label for="monthlyIncome">Average Monthly Income (KSH)</label>
            <input type="number" id="monthlyIncome" min="0" placeholder="e.g. 50000" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" required>
        </div>
     

           <div class="input-group">
                <label for="sourceOfIncome">Source of Income</label>
                <select id="sourceOfIncome" required>
                    <option value="" disabled selected>Select Source</option>
                    <option value="Salary">Salary</option>
                    <option value="BusinessProfit">Business Profits</option>
                    <option value="RentalIncome">Rental Income</option>
                    <option value="Other">Other</option>
                </select>
            </div>

             <div class="input-group">
            <label for="bankAccount">Bank Account Number (Optional)</label>
            <input type="text" id="bankAccount" placeholder="e.g. 1234567890" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
        </div>

        <button 
            type="submit" 
            id="submitButton"
            class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 mt-6 flex items-center justify-center shadow-lg transform hover:scale-[1.01]"
        >
            <span id="buttonText">Submit Application for Review</span>
            <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </button>
    </form>
</div>

<!-- 3. Firebase Configuration and Initialization (UPDATED) -->
<script type="module">
    // Firebase SDK Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ----------------------------------------------------------------------
        // CRITICAL FIX: The Firebase configuration and initialization block has
        // been REMOVED and is now handled by the 'firebase-config.js' script.
        // We can now access 'app', 'auth', 'db', and 'appId' globally.
        // ----------------------------------------------------------------------


    // Initialize Firebase Services
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Expose necessary services/variables globally
    window.db = db;
    window.auth = auth;
    window.appId = appId;
    window.onAuthStateChanged = onAuthStateChanged;
    window.getDoc = getDoc;
    window.doc = doc;
    window.setDoc = setDoc;

    // --- Authentication on Load (Initial Sign-in) ---
    async function initialSignIn() {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
                console.log("Firebase: Signed in with custom token.");
            } else {
                await signInAnonymously(auth);
                console.log("Firebase: Signed in anonymously.");
            }
        } catch (error) {
            console.error("Firebase Auth Error:", error);
        }
    }
    initialSignIn(); 
</script>

<script type="module">
    // Get elements
    const financialInfoForm = document.getElementById('financialInfoForm');
    const messageBox = document.getElementById('messageBox');
    const submitButton = document.getElementById('submitButton');
    const buttonText = document.getElementById('buttonText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const loadingMessage = document.getElementById('loadingMessage');

    let userId = null; // Variable to hold the current user's ID

    // Utility function for messages
    function showMessage(message, type, duration = 3000) {
        messageBox.textContent = message;
        messageBox.className = ``; // Clear existing classes
        messageBox.classList.add('messageBox', type);
        messageBox.classList.remove('hidden');

        // Hide message after duration
        setTimeout(() => {
            messageBox.classList.add('hidden');
        }, duration);
    }

    function toggleLoading(isLoading) {
        submitButton.disabled = isLoading;
        buttonText.textContent = isLoading ? 'Submitting...'  : 'Submit Application for Review';
        loadingSpinner.classList.toggle('hidden', !isLoading);
    }
    
    function togglePageLoading(isLoading) {
        loadingMessage.classList.toggle('hidden', !isLoading);
        financialInfoForm.classList.toggle('hidden', isLoading);
        if (isLoading) {
            // Disable the form to prevent interaction while loading
            financialInfoForm.querySelectorAll('input, select, button').forEach(el => el.disabled = true);
        } else {
             financialInfoForm.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
        }
    }

    // --- Data Loading Logic ---
    async function loadFinancialData(currentUserId) {
        togglePageLoading(true);

        try {
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/info`);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                const userData = userDoc.data();
                // Pre-fill form fields if data exists
                document.getElementById('monthlyIncome').value = userData.monthlyIncome || '';
                document.getElementById('sourceOfIncome').value = userData.sourceOfIncome || '';
                document.getElementById('bankName').value = userData.bankName || '';
                document.getElementById('bankAccount').value = userData.bankAccount || '';

                // Ensure user came from the correct step or is completing it
                if (userData.registrationStep !== 'financial_info' && userData.registrationStep !== 'approved') {
                     // Safety check: redirect back if they skipped steps
                     showMessage("Redirecting: Please complete previous steps first.", 'error');
                     setTimeout(() => {
                        window.location.href = 'personal_information.html';
                     }, 1500);
                     return;
                }
            } else {
                 showMessage("No application profile found. Redirecting to start.", 'error');
                 setTimeout(() => {
                    window.location.href = 'personal_information.html';
                 }, 1500);
                 return;
            }
        } catch (error) {
            console.error("Error loading user data:", error);
            showMessage("Failed to load existing data.", 'error');
        } finally {
            togglePageLoading(false);
        }
    }

    // --- Form Submission Handler (Save Financial Info) ---
    financialInfoForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        toggleLoading(true);

        if (!userId) {
            showMessage("Authentication error. Please sign in again.", 'error');
            toggleLoading(false);
            return;
        }

        const formData = {
            monthlyIncome: parseFloat(document.getElementById('monthlyIncome').value),
            sourceOfIncome: document.getElementById('sourceOfIncome').value,
            bankName: document.getElementById('bankName').value.trim(),
            bankAccount: document.getElementById('bankAccount').value.trim(),
            // Final step before approval
            registrationStep: 'approved'
        };

        try {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/info`);

            // Use setDoc with merge true to update existing fields without overwriting the whole document
            await setDoc(userDocRef, formData, { merge: true });

            showMessage("Application submitted! Checking approval status...", 'success');

            // Redirect to the final approval page
            setTimeout(() => {
                window.location.href = 'APPROVAL.HTML';
            }, 1000);

        } catch (error) {
            console.error("Error saving data:", error);
            showMessage(`Failed to submit application: ${error.message}`, 'error');
        } finally {
            toggleLoading(false);
        }
    });

    // --- Authentication Listener ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            userId = user.uid;
            console.log("Authenticated User ID:", userId);
            loadFinancialData(userId);
        } else {
            console.log("No user signed in. Redirecting to entry page.");
            // If the user somehow lands here unauthenticated, redirect them to sign in
            window.location.href = 'ENTRY PAGE.HTML';
        }
    });

</script>
</body>
</html>