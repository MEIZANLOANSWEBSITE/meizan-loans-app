<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEIZAN LOANS - Forgotten Password</title>
    <script src="https://cdn.tailwindcss.com"></script>
  <script src="firebase-config.js"></script> 
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fb923c; /* Orange-300 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #16a34a; /* Green-600 */
        }
        /* Style for custom message box */
        #messageBox {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 500;
        }
        .success {
            background-color: #d1fae5; /* Green-100 */
            color: #059669; /* Green-600 */
            border: 1px solid #10b981; /* Green-500 */
        }
        .error {
            background-color: #fee2e2; /* Red-100 */
            color: #ef4444; /* Red-600 */
            border: 1px solid #f87171; /* Red-400 */
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-3xl font-extrabold text-center text-green-600 mb-4">Reset Password</h1>
    <p class="text-gray-600 text-center mb-6">Enter your phone number to receive a password reset link.</p>

    <div id="messageBox" class="hidden" role="alert"></div>

    <form id="forgotPasswordForm">
        
        <div class="input-group mb-6">
            <label for="phone">Phone Number (Your ID)</label>
            <input 
                type="tel" 
                id="phone" 
                placeholder="e.g., 0712345678" 
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" 
                required
            >
        </div>

        <button 
            type="submit" 
            id="resetButton"
            class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 flex items-center justify-center shadow-lg transform hover:scale-[1.01]"
        >
            <span id="buttonText">Send Reset Link</span>
            <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </button>
    </form>

    <div class="text-center mt-4">
        <p class="text-gray-600 text-sm"><a href="ENTRY PAGE.HTML" class="text-orange-500 hover:text-orange-700 font-medium">Back to Sign In</a></p>
    </div>
</div>

<!-- 3. Firebase Configuration and Initialization (UPDATED) -->
<script type="module">
    // Firebase SDK Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    // getFirestore is not needed for this page but included for consistency
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

    // ----------------------------------------------------------------------
        // CRITICAL FIX: The Firebase configuration and initialization block has
        // been REMOVED and is now handled by the 'firebase-config.js' script.
        // We can now access 'app', 'auth', 'db', and 'appId' globally.
        // ----------------------------------------------------------------------
    // Initialize Firebase Services
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Expose necessary services/variables globally
    window.auth = auth;
    window.sendPasswordResetEmail = sendPasswordResetEmail;

    // --- Authentication on Load (Initial Sign-in) ---
    async function initialSignIn() {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
                console.log("Firebase: Signed in with custom token.");
            } else {
                await signInAnonymously(auth);
                console.log("Firebase: Signed in anonymously.");
            }
        } catch (error) {
            console.error("Firebase Auth Error:", error);
        }
    }
    initialSignIn(); 
</script>

<script type="module">
    // Get elements
    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    const telInput = document.getElementById('phone');
    const messageBox = document.getElementById('messageBox');
    const resetButton = document.getElementById('resetButton');
    const buttonText = document.getElementById('buttonText');
    const loadingSpinner = document.getElementById('loadingSpinner');

    // Utility function for messages
    function showMessage(message, type, duration = 3000) {
        messageBox.textContent = message;
        messageBox.className = ``; // Clear existing classes
        messageBox.classList.add('messageBox', type);
        messageBox.classList.remove('hidden');

        // Hide message after duration
        setTimeout(() => {
            messageBox.classList.add('hidden');
        }, duration);
    }

    function toggleLoading(isLoading) {
        resetButton.disabled = isLoading;
        buttonText.textContent = isLoading ? 'Sending...' : 'Send Reset Link';
        loadingSpinner.classList.toggle('hidden', !isLoading);
    }

    // --- Form Submission Handler (Password Reset Logic) ---
    forgotPasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        toggleLoading(true);

        const phone = telInput.value.trim();
        const email = phone + "@meizanloans.com"; // Pseudo email for Firebase Auth

        try {
            // 1. Send password reset email
            // NOTE: The user's provided Firebase config must have Email/Password sign-in enabled 
            // and a valid mail configuration for this to work in a real environment.
            await sendPasswordResetEmail(auth, email);

            showMessage("Password reset link sent! Check your email (or associated mailbox).", 'success', 6000);

            // 2. Redirect back to sign-in page after a delay
            setTimeout(() => {
                window.location.href = 'ENTRY PAGE.HTML';
            }, 3000);

        } catch (error) {
            console.error("Password Reset Error:", error);
            let errorMessage = "Failed to send reset link. Please check the phone number/ID.";

            // Handle common Firebase errors
            switch (error.code) {
                case 'auth/user-not-found':
                case 'auth/invalid-email':
                    errorMessage = "The provided phone number is not registered or is invalid.";
                    break;
                default:
                    errorMessage = `Reset failed: ${error.message}`;
            }
            showMessage(errorMessage, 'error');
        } finally {
            toggleLoading(false);
        }
    });

</script>
</body>
</html>