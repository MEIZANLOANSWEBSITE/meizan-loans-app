<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>  MEIZAN LOANS - Sign In</title>
    <script src="https://cdn.tailwindcss.com"></script>
<script src="firebase-config.js"></script> 
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fb923c; /* Orange-300 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #16a34a; /* Green-600 */
        }
        /* Style for custom message box */
        #messageBox {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 500;
        }
        .success {
            background-color: #d1fae5; /* Green-100 */
            color: #059669; /* Green-600 */
            border: 1px solid #10b981; /* Green-500 */
        }
        .error {
            background-color: #fee2e2; /* Red-100 */
            color: #ef4444; /* Red-600 */
            border: 1px solid #f87171; /* Red-400 */
        }
        .info {
            background-color: #e0f2f1; /* Cyan-50 */
            color: #06b6d4; /* Cyan-600 */
            border: 1px solid #22d3ee; /* Cyan-400 */
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-3xl font-extrabold text-center text-green-600 mb-6">MEIZAN LOANS </h1>
    <h1 class="text-3xl font-extrabold text-center text-green-600 mb-6">Sign in </h1>


    <div id="messageBox" class="hidden" role="alert"></div>

    <form id="signInForm">
        
        <div class="input-group mb-4">
            <label for="phone">Phone Number (Your ID)</label>
            <input 
                type="tel" 
                id="phone" 
                placeholder="e.g., 0712345678" 
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" 
                required
            >
        </div>

        <div class="input-group mb-6">
            <label for="password">Password</label>
            <input 
                type="password" 
                id="password" 
                placeholder="Enter your password" 
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" 
                required
            >
            <div class="text-right mt-2">
                <a href="forgotten password.html" class="text-xs text-orange-500 hover:text-orange-700 font-medium transition duration-200">Forgotten Password?</a>
            </div>
        </div>

        <button 
            type="submit" 
            id="signInButton"
            class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 flex items-center justify-center shadow-lg transform hover:scale-[1.01]"
        >
            <span id="buttonText">Sign In</span>
            <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </button>
    </form>

    <div class="text-center mt-6">
        <p class="text-gray-600 text-sm">Don't have an account? <a href="registration.html" class="text-orange-500 hover:text-orange-700 font-medium">Register Now</a></p>
    </div>
</div>

<!-- 3. Firebase Configuration and Initialization (UPDATED) -->
<script type="module">
    // Firebase SDK Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

   
        // ----------------------------------------------------------------------
        // CRITICAL FIX: The Firebase configuration and initialization block has
        // been REMOVED and is now handled by the 'firebase-config.js' script.
        // We can now access 'app', 'auth', 'db', and 'appId' globally.
        // ----------------------------------------------------------------------


    // Initialize Firebase Services
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Expose necessary services/variables globally
    window.db = db;
    window.auth = auth;
    window.appId = appId;
    window.getDoc = getDoc;
    window.doc = doc;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword;

    // --- Authentication on Load (Initial Sign-in) ---
    async function initialSignIn() {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
                console.log("Firebase: Signed in with custom token.");
            } else {
                await signInAnonymously(auth);
                console.log("Firebase: Signed in anonymously.");
            }
        } catch (error) {
            console.error("Firebase Auth Error:", error);
        }
    }
    initialSignIn(); 
</script>

<script type="module">
    // Get elements
    const signInForm = document.getElementById('signInForm');
    const phoneInput = document.getElementById('phone');
    const passwordInput = document.getElementById('password');
    const messageBox = document.getElementById('messageBox');
    const signInButton = document.getElementById('signInButton');
    const buttonText = document.getElementById('buttonText');
    const loadingSpinner = document.getElementById('loadingSpinner');

    // Utility function for messages
    function showMessage(message, type, duration = 3000) {
        messageBox.textContent = message;
        messageBox.className = ``; // Clear existing classes
        messageBox.classList.add('messageBox', type);
        messageBox.classList.remove('hidden');

        // Hide message after duration
        setTimeout(() => {
            messageBox.classList.add('hidden');
        }, duration);
    }

    function toggleLoading(isLoading) {
        signInButton.disabled = isLoading;
        buttonText.textContent = isLoading ? 'Signing In...' : 'Sign In';
        loadingSpinner.classList.toggle('hidden', !isLoading);
    }

    // --- Form Submission Handler (Sign In Logic) ---
    signInForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        toggleLoading(true);

        const phone = phoneInput.value.trim();
        const password = passwordInput.value;
        const email = phone + "@meizanloans.com"; // Pseudo email for Firebase Auth

        try {
            // 1. Sign in the user
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const userId = userCredential.user.uid;

            // 2. Fetch user data from Firestore to determine redirect
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/info`);
            const userDoc = await getDoc(userDocRef);

            let nextUrl = 'APPROVAL.HTML'; // Default redirect to dashboard

            if (userDoc.exists()) {
                const userData = userDoc.data();
                
                // Determine the next step based on registration progress
                switch(userData.registrationStep) {
                    case 'personal_info':
                        nextUrl = 'personal_information.html';
                        break;
                    case 'financial_info':
                        nextUrl = 'financial_information.html';
                        break;
                    case 'approved':
                    case 'withdrawn':
                    case 'repayment_due':
                    case 'completed':
                        // For any other status, go to the final status page
                        nextUrl = 'APPROVAL.HTML';
                        break;
                    default:
                        // Fallback to the first step if status is missing/unknown
                        nextUrl = 'personal_information.html';
                }
                
            } else {
                // Should not happen if registration worked, but handle missing data gracefully
                console.warn("User data not found in Firestore. Redirecting to first step.");
                nextUrl = 'personal_information.html';
            }

            showMessage("Sign in successful! Redirecting...", 'success');

            // 3. Redirect
            setTimeout(() => {
                window.location.href = nextUrl;
            }, 1000);


        } catch (error) {
            console.error("Sign In Error:", error);
            let errorMessage = "An unknown error occurred. Please check your credentials.";

            // Handle common Firebase errors
            switch (error.code) {
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    errorMessage = "Invalid phone number or password.";
                    break;
                case 'auth/invalid-email':
                    errorMessage = "Invalid phone number format. Please ensure it is correct.";
                    break;
                default:
                    errorMessage = `Sign in failed: ${error.message}`;
            }
            showMessage(errorMessage, 'error');

        } finally {
            toggleLoading(false);
        }
    });

</script>
</body>
</html>