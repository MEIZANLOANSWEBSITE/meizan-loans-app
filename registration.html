<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEIZAN LOANS - Registration</title>
    <script src="https://cdn.tailwindcss.com"></script>
  <script src="firebase-config.js"></script> 
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fb923c; /* Orange-300 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #16a34a; /* Green-600 */
        }
        /* Style for custom message box */
        #messageBox {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 500;
        }
        .success {
            background-color: #d1fae5; /* Green-100 */
            color: #059669; /* Green-600 */
            border: 1px solid #10b981; /* Green-500 */
        }
        .error {
            background-color: #fee2e2; /* Red-100 */
            color: #ef4444; /* Red-600 */
            border: 1px solid #f87171; /* Red-400 */
        }
        .info {
            background-color: #e0f2f1; /* Cyan-50 */
            color: #06b6d4; /* Cyan-600 */
            border: 1px solid #22d3ee; /* Cyan-400 */
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-3xl font-extrabold text-center text-green-600 mb-6">Create Your Account</h1>

    <div id="messageBox" class="hidden" role="alert"></div>

    <form id="registrationForm">
        
        <div class="input-group mb-4">
            <label for="phone">Phone Number (Used as ID)</label>
            <input 
                type="tel" 
                id="phone" 
                placeholder="e.g., 0712345678" 
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" 
                required
            >
        </div>

        <div class="input-group mb-4">
            <label for="password">Password</label>
            <input 
                type="password" 
                id="password" 
                placeholder="Minimum 6 characters" 
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" 
                minlength="6"
                required
            >
        </div>

        <div class="input-group mb-6">
            <input type="checkbox" id="terms" required class="mr-2 text-green-600 focus:ring-green-500">
            <label for="terms" class="text-sm font-normal text-gray-600 inline">I agree to the <a href="TERMS AND CONDTIONS.HTML" target="_blank" class="text-orange-500 hover:text-orange-700 font-medium">Terms and Conditions</a>.</label>
        </div>

        <button 
            type="submit" 
            id="registerButton"
            class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 flex items-center justify-center shadow-lg transform hover:scale-[1.01]"
        >
            <span id="buttonText">Register Account</span>
            <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </button>
    </form>

    <div class="text-center mt-4">
        <p class="text-gray-600 text-sm">Already have an account? <a href="ENTRY PAGE.HTML" class="text-orange-500 hover:text-orange-700 font-medium">Sign In</a></p>
    </div>
</div>

<!-- 3. Firebase Configuration and Initialization (UPDATED) -->
<script type="module">
    // Firebase SDK Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

   
        // ----------------------------------------------------------------------
        // CRITICAL FIX: The Firebase configuration and initialization block has
        // been REMOVED and is now handled by the 'firebase-config.js' script.
        // We can now access 'app', 'auth', 'db', and 'appId' globally.
        // ----------------------------------------------------------------------

    // Initialize Firebase Services
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Expose necessary services/variables globally
    window.db = db;
    window.auth = auth;
    window.appId = appId;
    window.setDoc = setDoc;
    window.doc = doc;
    window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;

    // --- Authentication on Load (Initial Sign-in) ---
    async function initialSignIn() {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
                console.log("Firebase: Signed in with custom token.");
            } else {
                await signInAnonymously(auth);
                console.log("Firebase: Signed in anonymously.");
            }
        } catch (error) {
            console.error("Firebase Auth Error:", error);
        }
    }
    initialSignIn(); 

    // Get elements
    const registrationForm = document.getElementById('registrationForm');
    const phoneInput = document.getElementById('phone');
    const passwordInput = document.getElementById('password');
    const messageBox = document.getElementById('messageBox');
    const registerButton = document.getElementById('registerButton');
    const buttonText = document.getElementById('buttonText');
    const loadingSpinner = document.getElementById('loadingSpinner');

    // Utility function for messages
    function showMessage(message, type, duration = 3000) {
        messageBox.textContent = message;
        messageBox.className = ``; // Clear existing classes
        messageBox.classList.add('messageBox', type);
        messageBox.classList.remove('hidden');

        // Hide message after duration
        setTimeout(() => {
            messageBox.classList.add('hidden');
        }, duration);
    }

    function toggleLoading(isLoading) {
        registerButton.disabled = isLoading;
        buttonText.textContent = isLoading ? 'Registering...' : 'Register Account';
        loadingSpinner.classList.toggle('hidden', !isLoading);
    }

    // --- Form Submission Handler (Registration Logic) ---
    registrationForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        toggleLoading(true);

        const phone = phoneInput.value.trim();
        const password = passwordInput.value;
        // Firebase Auth requires an email format. We create a pseudo email from the phone number.
        const email = phone + "@meizanloans.com"; 

        try {
            // 1. Create user in Firebase Auth
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            const userId = user.uid;
            
            // 2. Save user profile to Firestore
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/info`);
            
            await setDoc(userDocRef, {
                phone: phone, // Save the actual phone number
                email: email, // Save the pseudo email for reference
                registrationDate: new Date().toISOString(),
                // This is the status update field for progress tracking
                registrationStep: 'personal_info',
                loanStatus: 'Not Applied'
            });

            showMessage("Registration successful! Redirecting...", 'success');

            // 3. Redirect to the next step
            setTimeout(() => {
                window.location.href = 'personal_information.html'; 
            }, 1500);

        } catch (error) {
            console.error("Registration Error:", error);
            let errorMessage = "An unknown error occurred during registration. Please try again.";

            // Handle common Firebase errors
            switch (error.code) {
                case 'auth/email-already-in-use':
                    errorMessage = "This phone number is already registered. Please sign in or use a different number.";
                    break;
                case 'auth/weak-password':
                    errorMessage = "Password is too weak. Must be at least 6 characters.";
                    break;
                case 'auth/invalid-email':
                    errorMessage = "Invalid phone number format. Please ensure it is correct.";
                    break;
                default:
                    errorMessage = `Registration failed: ${error.message}`;
            }
            showMessage(errorMessage, 'error');
        } finally {
            toggleLoading(false);
        }
    });

</script>
</body>
</html>