<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEIZAN LOANS - Trust Fee Payment</title>
    <script src="https://cdn.tailwindcss.com"></script>
<script src="firebase-config.js"></script> 
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fb923c; /* Orange-300 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            margin: 0;
        }
        .paybill-card {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }
        .instruction-box {
            background-color: #fffbeb; /* Yellow-50 */
            border: 2px dashed #f59e0b; /* Amber-500 */
            padding: 1.5rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
        }
        .data-point {
            display: flex;
            justify-content: space-between;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px dotted #d1d5db;
            padding-bottom: 0.25rem;
        }
        .data-point span:first-child {
            color: #6b7280;
        }
        .data-point span:last-child {
            font-weight: 700;
            color: #059669; /* Green-600 */
        }
        /* Style for custom message box */
        #messageBox {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 500;
        }
        .success {
            background-color: #d1fae5; /* Green-100 */
            color: #059669; /* Green-600 */
            border: 1px solid #10b981; /* Green-500 */
        }
        .error {
            background-color: #fee2e2; /* Red-100 */
            color: #ef4444; /* Red-600 */
            border: 1px solid #f87171; /* Red-400 */
        }
        .info {
            background-color: #e0f2f1; /* Cyan-50 */
            color: #06b6d4; /* Cyan-600 */
            border: 1px solid #22d3ee; /* Cyan-400 */
        }
    </style>
</head>
<body>

<div class="paybill-card">
    <div id="messageBox" class="hidden" role="alert"></div>

    <h1 id="pageTitle" class="text-3xl font-extrabold text-center text-green-600 mb-8">Loan Withdrawal: Trust Fee</h1>
    
    <div id="paymentDetails" class="mb-6 hidden">
        <h2 class="text-xl font-bold text-orange-500 mb-4">Payment Summary</h2>
        <div class="data-point">
            <span>Amount to Pay:</span>
            <span id="amountToPay">KSH 0</span>
        </div>
        <div class="data-point">
            <span>Reference (Account No.):</span>
            <span id="accountNumber">Loading...</span>
        </div>
    </div>

    <div class="instruction-box">
        <p class="font-bold text-lg text-amber-700 mb-3">M-Pesa Instructions:</p>
        <ol class="list-decimal list-inside space-y-2 text-gray-700">
            <li>Go to **M-PESA** MENU ON YOUR PHONE.</li>
            <li>Select **SEND MONEY** .</li>
            <li>Enter PHONE NUMBER ( SEND TO): **<span class="font-bold text-red-600">0710304790</span>**.</li>
            <li>Enter PHONE NUMBER ( SEND TO): **<span id="instructionAccountNumber" class="font-bold text-red-600">0710304790</span>**</li>
            <li>Enter the **<span id="instructionAmount" class="font-bold text-red-600"> Trust Fee Amount= ksh 100    </span>**.</li>
            <li>Enter your M-Pesa PIN and Confirm.</li>
        </ol>
    </div>

    <form id="confirmationForm">
        <h3 class="text-xl font-bold text-gray-700 mb-4">Confirm Payment</h3>
        <div class="input-group mb-6">
            <label for="transactionCode">Enter M-Pesa Transaction Code (e.g., QRT1A45B1CD)</label>
            <input 
                type="text" 
                id="transactionCode" 
                placeholder="Transaction Code" 
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 uppercase" 
                required
            >
        </div>

        <button 
            type="submit" 
            id="confirmButton"
            class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 flex items-center justify-center shadow-lg transform hover:scale-[1.01]"
        >
            <span id="buttonText">Confirm Payment</span>
            <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </button>
    </form>
    
    <div id="successMessageArea" class="hidden mt-6 text-center">
        <!-- Success message dynamically generated here -->
    </div>
</div>

<!-- 3. Firebase Configuration and Initialization (UPDATED) -->
<script type="module">
    // Firebase SDK Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ----------------------------------------------------------------------
        // CRITICAL FIX: The Firebase configuration and initialization block has
        // been REMOVED and is now handled by the 'firebase-config.js' script.
        // We can now access 'app', 'auth', 'db', and 'appId' globally.
        // ----------------------------------------------------------------------
    // Initialize Firebase Services
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Expose necessary services/variables globally
    window.db = db;
    window.auth = auth;
    window.appId = appId;
    window.onAuthStateChanged = onAuthStateChanged;
    window.getDoc = getDoc;
    window.doc = doc;
    window.setDoc = setDoc;

    // --- Authentication on Load (Initial Sign-in) ---
    async function initialSignIn() {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
                console.log("Firebase: Signed in with custom token.");
            } else {
                await signInAnonymously(auth);
                console.log("Firebase: Signed in anonymously.");
            }
        } catch (error) {
            console.error("Firebase Auth Error:", error);
        }
    }
    initialSignIn(); 
</script>

<script type="module">
    // Get elements
    const pageTitle = document.getElementById('pageTitle');
    const confirmationForm = document.getElementById('confirmationForm');
    const transactionCodeInput = document.getElementById('transactionCode');
    const confirmButton = document.getElementById('confirmButton');
    const buttonText = document.getElementById('buttonText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const messageBox = document.getElementById('messageBox');
    const paymentDetails = document.getElementById('paymentDetails');
    const amountToPayDisplay = document.getElementById('amountToPay');
    const accountNumberDisplay = document.getElementById('accountNumber');
    const instructionAccountNumber = document.getElementById('instructionAccountNumber');
    const instructionAmount = document.getElementById('instructionAmount');
    const successMessageArea = document.getElementById('successMessageArea');

    let userId = null;
    let loanDetails = null;
    let isRepayment = false;

    // Utility function for messages
    function showMessage(message, type, duration = 3000) {
        messageBox.textContent = message;
        messageBox.className = ``; // Clear existing classes
        messageBox.classList.add('messageBox', type);
        messageBox.classList.remove('hidden');

        // Hide message after duration
        setTimeout(() => {
            messageBox.classList.add('hidden');
        }, duration);
    }
    
    function setButtonLoading(isLoading) {
        confirmButton.disabled = isLoading;
        buttonText.textContent = isLoading ? 'Confirming...' : 'Confirm Payment';
        loadingSpinner.classList.toggle('hidden', !isLoading);
    }

    function formatKSH(amount) {
        return `KSH ${amount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
    }

    // --- Data Loading Logic ---
    async function loadPaymentDetails(currentUserId) {
        showMessage("Loading loan details...", 'info', 0);
        
        // Check URL for repayment flag
        const urlParams = new URLSearchParams(window.location.search);
        isRepayment = urlParams.get('action') === 'repay';
        
        // 1. Get loan details from localStorage (set in APPROVAL.HTML)
        const storedLoanDetails = localStorage.getItem('loanDetails');
        if (storedLoanDetails) {
            loanDetails = JSON.parse(storedLoanDetails);
        }

        if (!loanDetails) {
            showMessage("Loan details not found. Please go back to the dashboard.", 'error');
            return;
        }

        // 2. Fetch National ID for Account Number
        try {
            const userDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/info`);
            const userDoc = await getDoc(userDocRef);
            
            if (!userDoc.exists() || !userDoc.data().nationalId) {
                showMessage("User ID not found. Please complete personal information.", 'error');
                setTimeout(() => { window.location.href = 'personal_information.html'; }, 2000);
                return;
            }

            const nationalId = userDoc.data().nationalId;
            
            // Determine payment amount and update UI
            const amount = isRepayment ? loanDetails.totalRepayment : loanDetails.trustFee;
            const actionText = isRepayment ? 'Loan Repayment' : 'Trust Fee Payment';

            pageTitle.textContent = actionText;
            amountToPayDisplay.textContent = formatKSH(amount);
            accountNumberDisplay.textContent = nationalId;
            instructionAccountNumber.textContent = nationalId;
            instructionAmount.textContent = formatKSH(amount);
            
            // Show details and hide loading
            paymentDetails.classList.remove('hidden');
            messageBox.classList.add('hidden');

        } catch (error) {
            console.error("Error loading user data:", error);
            showMessage("Failed to load required user data.", 'error');
        }
    }

    // --- Submission Handler ---
    async function handleSubmission(e) {
        e.preventDefault();
        setButtonLoading(true);

        const transactionCode = transactionCodeInput.value.trim().toUpperCase();
        
        if (!userId || !loanDetails) {
            showMessage("System error: Missing user or loan data.", 'error', 5000);
            setButtonLoading(false);
            return;
        }
        
        // Mock verification delay
        showMessage(`Processing ${isRepayment ? 'Repayment' : 'Fee'} Confirmation...`, 'info', 0);

        try {
            // 1. Update Firestore status (Mocking verification)
            const newStatus = isRepayment ? 'Completed' : 'Withdrawn';
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/info`);

            await setDoc(userDocRef, {
                loanStatus: newStatus,
                lastTransactionCode: transactionCode,
                lastTransactionDate: new Date().toISOString()
            }, { merge: true });

            // 2. Display success message based on action
            confirmationForm.classList.add('hidden');
            messageBox.classList.add('hidden');
            successMessageArea.classList.remove('hidden');

            if (isRepayment) {
                 successMessageArea.innerHTML = `
                    <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p class="text-2xl font-bold text-green-600 mb-2">Repayment Confirmed!</p>
                    <p class="text-gray-700">Your loan repayment has been submitted for final verification.</p>
                    <p class="text-gray-600 mt-4">Thank you for repaying your loan. Redirecting to the dashboard shortly.</p>
                `;
            } else {
                successMessageArea.innerHTML = `
                    <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p class="text-2xl font-bold text-green-600 mb-2">Fee Confirmed!</p>
                    <p class="text-gray-700 font-semibold">Transaction: ${transactionCode}</p>
                    <p class="text-gray-700 mt-2">
                        An administrator will now verify the M-Pesa transaction. Once verified,
                        you will receive a call and your loan of KSH ${loanDetails.netDisbursed.toLocaleString()} will be disbursed.
                    </p>
                    <p class="text-gray-600">
                        Thank you for your patience. You will be redirected to the dashboard shortly.
                    </p>
                `;
            }
            
            // Redirect back to dashboard after a delay
            setTimeout(() => {
                window.location.href = 'APPROVAL.HTML'; 
            }, 8000);

        } catch (error) {
            console.error("Submission failed:", error);
            showMessage("Submission failed due to a system error. Please try again.", 'error', 5000);
            setButtonLoading(false);
        }
    }

    // --- Event Listeners and Authentication ---\
    confirmationForm.addEventListener('submit', handleSubmission);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            userId = user.uid;
            loadPaymentDetails(userId);
        } else {
            console.log("No user signed in. Redirecting to entry page.");
            showMessage("You are not signed in. Redirecting...", 'error');
            setTimeout(() => {
                window.location.href = 'ENTRY PAGE.HTML';
            }, 2000);
        }
    });

</script>
</body>
</html>